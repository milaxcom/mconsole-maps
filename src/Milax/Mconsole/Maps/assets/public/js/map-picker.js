var MapPicker=function(e,t){this.container=e,this.geocoder=new google.maps.Geocoder,this.address=[],(isNaN(t.center.lat)||isNaN(t.center.lng))&&delete t.center,this.config={center:{lat:55.7494733,lng:37.3523241},zoom:4},t&&$.extend(this.config,t),this.init()};MapPicker.prototype.use=function(e){return this.useCb=e,this},MapPicker.prototype.cancel=function(e){return this.cancelCb=e,this},MapPicker.prototype.init=function(){this.map=new google.maps.Map(this.container.find(".map").get(0),this.config),this.map.addListener("click",function(e){this.setMarker(e.latLng)}.bind(this)),this.addSearchBox(),0!=this.config.lat&&0!=this.config.lng&&this.setMarker(this.config.center),this.container.on("click",".map-use",function(){this.useCb&&this.useCb(this.address,this.marker.position.toJSON())}.bind(this)),this.container.on("click",".map-close",function(){this.cancelCb&&this.cancelCb()}.bind(this))},MapPicker.prototype.addSearchBox=function(){var e=document.getElementById("pac-input"),t=new google.maps.places.SearchBox(e);this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(e),t.setBounds(this.map.getBounds()),this.map.addListener("bounds_changed",function(){t.setBounds(this.map.getBounds())}.bind(this)),t.addListener("places_changed",function(){var e=t.getPlaces();if(0!=e.length){var s=new google.maps.LatLngBounds;e.forEach(function(e){({url:e.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)});this.setMarker(e.geometry.location),e.geometry.viewport?s.union(e.geometry.viewport):s.extend(e.geometry.location)}.bind(this)),this.map.fitBounds(s)}}.bind(this))},MapPicker.prototype.setMarker=function(e){this.marker&&this.marker.setMap(null),this.marker=new google.maps.Marker({position:e,map:this.map}),this.geocode(e),this.marker.setMap(this.map)},MapPicker.prototype.geocode=function(e){this.container.block({message:null,overlayCSS:{opacity:0}}),this.geocoder.geocode({location:e},function(e,t){if(this.address=[],t===google.maps.GeocoderStatus.OK&&e.length>0){this.address.push({type:"formatted_address",long_name:e[0].formatted_address});for(var s in e[0].address_components){var o=e[0].address_components[s],n=o.types[0];this.address.push({type:n,long_name:o.long_name,short_name:o.short_name})}}this.container.unblock(),this.fillAddressCard()}.bind(this))},MapPicker.prototype.fillAddressCard=function(){var e=this.container.find(".map-address");if(0==this.address.length)e.html("No address info found at selected location.");else{e.html("");for(var t in this.address){var s=this.address[t],o=s.type.charAt(0).toUpperCase()+s.type.slice(1).split("_").join(" "),n=s.short_name?" ("+s.short_name+")":"";e.append($("<address><strong>"+o+"</strong> ("+s.type+")<br>"+s.long_name+n+"</address>"))}}this.toggleControls()},MapPicker.prototype.toggleControls=function(){0==this.address.length?this.container.find(".map-use-controls").addClass("hide"):this.container.find(".map-use-controls").removeClass("hide")},$.fn.mapPicker=function(e){return new MapPicker(this,e)};